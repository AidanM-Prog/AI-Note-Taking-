<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üéôÔ∏è AI Note Taker</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
<style>
body {
    font-family: 'Inter', sans-serif;
    background: #f0f2f5;
    color: #333;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: background 0.3s, color 0.3s;
}
body.dark { background: #212121; color: #e5e7eb; }

header {
    text-align: center;
    padding: 40px 20px 10px;
    position: relative;
}
h1 { margin: 0; font-weight: 600; font-size: 2.2em; color: #4a90e2; }
#clock { margin-top: 10px; font-size: 1.1em; color: #555; transition: color 0.3s; }
body.dark #clock { color: #cbd5e1; }

.theme-toggle, .trash-btn {
    position: fixed;
    top: 10px;
    background: none;
    border: none;
    font-size: 1.6em;
    cursor: pointer;
    color: #555;
    transition: color 0.3s;
    z-index: 1000;
}
.theme-toggle { right: 10px; }
.trash-btn { right: 85px; }
body.dark .theme-toggle, body.dark .trash-btn { color: #e5e7eb; }
.trash-btn:hover { color: #ff4d4d; }

.controls {
    margin: 20px 0;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
}

button {
    background: linear-gradient(135deg, #4a90e2, #357ABD);
    border: none;
    color: #fff;
    padding: 12px 25px;
    font-size: 1em;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-weight: 600;
}
button:disabled { background: #2a5c99; cursor: not-allowed; box-shadow: none; }
button:hover:not(:disabled) {
    background: linear-gradient(135deg, #357ABD, #2a5c99);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

.output {
    width: 90%;
    max-width: 900px;
    margin-bottom: 40px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
}

.card {
    background: #ffffffcc;
    border-radius: 15px;
    padding: 20px;
    transition: background 0.3s, color 0.3s;
}
body.dark .card { background: #131313; color: #e5e7eb; }
.card h2 { margin-top: 0; color: #4a90e2; }
p { white-space: pre-wrap; }

.audio-player {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    border-radius: 8px;
    background: #ffffffcc;
    transition: background 0.3s, color 0.3s;
}
body.dark .audio-player { background: #131313; }
.audio-player button {
    background: #4a90e2;
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 25%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: background 0.3s;
}
.audio-player button:hover { background: #357ABD; }
.audio-player input[type="range"] {
    flex: 1;
    height: 4px;
    border-radius: 2px;
    background: #d1d5db;
    appearance: none;
    cursor: pointer;
}
body.dark .audio-player input[type="range"] { background: #555; }
.audio-player span { font-size: 0.85em; color: #333; white-space: nowrap; }
body.dark .audio-player span { color: #e5e7eb; }

.recent-files-bar {
    background: #ffffffcc;
    border-radius: 15px;
    padding: 15px;
    display: flex;
    gap: 10px;
    overflow-x: auto;
    justify-content: center;    
    flex-wrap: nowrap;
}
body.dark .recent-files-bar { background: #131313; }
.recent-file-item {
    flex: 0 0 30%;
    min-width: 0;
    background: #f4f4f4;
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: flex-start;
    height: 25px;
    text-align: center;
}
body.dark .recent-file-item { background: #1f1f1f; color: #e5e7eb; }
.recent-file-item:hover { background: #4a90e2; color: white; transition: all 0.3s ease; transform: translateY(-2px); }
body.dark .recent-file-item:hover { background-color: #357ABD; }

/* üîπ Custom popup for naming */
.popup {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
    transition: opacity 0.3s ease;
}
.popup.hidden { opacity: 0; pointer-events: none; }

.popup-content {
    background: #fff;
    color: #000;
    border-radius: 16px;
    padding: 1.5rem 2rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.25);
    text-align: center;
    width: 90%;
    max-width: 400px;
    transform: scale(0.8);
    opacity: 0;
    animation: popupIn 0.3s forwards;
}
body.dark .popup-content { background: #1f1f1f; color: #e5e7eb; }

.popup-content h3 { margin-bottom: 1rem; font-size: 1.3rem; }
.popup-content input {
    width: 100%;
    padding: 0.6rem;
    border-radius: 10px;
    border: 1px solid #999;
    outline: none;
    margin-bottom: 1rem;
    font-size: 1rem;
    background: #f7f7f7;
}
body.dark .popup-content input { background: #2a2a2a; color: #e5e7eb; }

.popup-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}
.popup-buttons button {
    flex: 1;
    padding: 0.6rem;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s ease;
}
#popupCancel { background: #999; color: #fff; }
#popupSave { background: #4a90e2; color: #fff; }
#popupCancel:hover { background: #777; }
#popupSave:hover { background: #357ABD; }

@keyframes popupIn {
    to { transform: scale(1); opacity: 1; }
}

/* üîπ Fake waveform icon */
.waveform-icon {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 16px;
    margin-right: 8px;
}
.wave-bar {
    width: 2px;
    background: #4a90e2;
    border-radius: 1px;
    animation: pulse 1.5s infinite ease-in-out;
}
.wave-bar:nth-child(1){height:6px;animation-delay:0s;}
.wave-bar:nth-child(2){height:10px;animation-delay:0.2s;}
.wave-bar:nth-child(3){height:14px;animation-delay:0.4s;}
.wave-bar:nth-child(4){height:10px;animation-delay:0.6s;}
.wave-bar:nth-child(5){height:6px;animation-delay:0.8s;}
body.dark .wave-bar { background: #62a9ff; }
@keyframes pulse {0%,100%{transform:scaleY(1);opacity:0.8;}50%{transform:scaleY(1.3);opacity:1;}}
</style>
</head>
<body class="dark">
<header>
    <h1><i class="fa-solid fa-microphone-lines"></i> AI Note Taker</h1>
    <button class="theme-toggle" id="themeToggle"><i class="fa-solid fa-moon"></i></button>
    <button class="trash-btn" id="trashBtn"><i class="fa-solid fa-trash"></i></button>
    <div id="clock"></div>
    <p>Record a note or upload an audio file to get transcript & summary.</p>
</header>

<div id="fileWarning" style="width: 80%; max-width: 900px; text-align: center; margin: 1px auto; font-weight: 600; font-size: 15px; color: #ff4d4d;">
    ‚ö†Ô∏è DO NOT have duplicate names for your files!
</div>


<div class="controls">
    <button id="recordBtn"><i class="fa-solid fa-microphone"></i> Start Recording</button>
    <button id="uploadBtn"><i class="fa-solid fa-upload"></i> Upload Audio</button>
    <input type="file" id="uploadInput" accept="audio/*" style="display:none;">
    <button id="downloadBtn" disabled><i class="fa-solid fa-download"></i> Download</button>
    <button id="clearBtn"><i class="fa-solid fa-trash-can"></i> Clear</button>
</div>

<div class="output">
    <div class="card">
        <h2><i class="fa-solid fa-play"></i> Playback</h2>
        <div class="audio-player">
            <button id="playBtn"><i class="fa-solid fa-play"></i></button>
            <input type="range" id="seekBar" value="0" min="0" step="1">
            <span id="timeDisplay">00:00 / 00:00</span>
        </div>
    </div>

    <div class="card">
        <h2><i class="fa-solid fa-quote-left"></i> Transcript</h2>
        <p id="transcript">None yet.</p>
    </div>

    <div class="card">
        <h2><i class="fa-solid fa-list-check"></i> Summary</h2>
        <p id="summary">None yet.</p>
    </div>

    <div class="card">
        <h2><i class="fa-solid fa-clock-rotate-left"></i> Recent Files</h2>
        <div id="recentFiles" class="recent-files-bar">
            <span style="opacity:0.4;">No recent files</span>
        </div>
    </div>
</div>

<!-- üìÑ Custom popup -->
<div id="filenamePopup" class="popup hidden">
  <div class="popup-content">
    <h3>Name your note</h3>
    <input type="text" id="filenameInput" placeholder="Enter note name..." />
    <div class="popup-buttons">
      <button id="popupCancel">Cancel</button>
      <button id="popupSave">Save</button>
    </div>
  </div>
</div>

<!-- Trash Modal -->
<div id="trashModal" class="popup hidden">
  <div class="popup-content">
    <h3>Trash</h3>
    <div id="trashList" style="max-height:300px; overflow-y:auto;"></div>
    <div style="margin-top: 1rem;">
      <button id="closeTrashBtn">Close</button>
    </div>
  </div>
</div>

<script>
let mediaRecorder, audioChunks=[], latestTranscript="", latestSummary="", chosenFilename="", pendingFile=null, isRecording=false;
let audio = new Audio();
let recentFiles = [];

const recordBtn = document.getElementById("recordBtn");
const uploadBtn = document.getElementById("uploadBtn");
const uploadInput = document.getElementById("uploadInput");
const transcriptDiv = document.getElementById("transcript");
const summaryDiv = document.getElementById("summary");
const downloadBtn = document.getElementById("downloadBtn");
const themeToggle = document.getElementById("themeToggle");
const playBtn = document.getElementById("playBtn");
const seekBar = document.getElementById("seekBar");
const timeDisplay = document.getElementById("timeDisplay");
const recentFilesDiv = document.getElementById("recentFiles");
const clearBtn = document.getElementById("clearBtn");
const trashBtn = document.getElementById("trashBtn");
const trashModal = document.getElementById("trashModal");
const trashList = document.getElementById("trashList");
const closeTrashBtn = document.getElementById("closeTrashBtn");

function updateClock(){
    const now = new Date();
    const date = now.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const time = now.toLocaleTimeString();
    document.getElementById("clock").textContent = `${date} | ${time}`;
}
setInterval(updateClock,1000); updateClock();

function blobToBase64(blob){
    return new Promise((resolve)=>{
        const reader=new FileReader();
        reader.onloadend=()=>resolve(reader.result);
        reader.readAsDataURL(blob);
    });
}
async function base64ToBlob(base64){ const res=await fetch(base64); return await res.blob(); }

async function askFilename(defaultName="New Note") {
    // Fetch existing filenames from the server
    let existing = [];
    try {
        const res = await fetch("/list_recordings");
        const data = await res.json();
        existing = data.map(f => f.split("/")[1]); // get subfolder names
    } catch(err) { console.error("Could not fetch existing files:", err); }

    // Automatically add numeric suffix if duplicate exists
    let finalName = defaultName;
    let counter = 1;
    while(existing.includes(finalName)) {
        finalName = `${defaultName} ${counter}`;
        counter++;
    }

    return new Promise((resolve) => {
        const popup = document.getElementById("filenamePopup");
        const input = document.getElementById("filenameInput");
        const saveBtn = document.getElementById("popupSave");
        const cancelBtn = document.getElementById("popupCancel");

        input.value = finalName;
        popup.classList.remove("hidden");
        input.focus();

        const handleKey = (e) => {
            if (e.key === "Enter") saveBtn.click();
        };
        input.addEventListener("keydown", handleKey);

        const cleanup = () => {
            popup.classList.add("hidden");
            saveBtn.onclick = cancelBtn.onclick = null;
            input.removeEventListener("keydown", handleKey);
        };

        saveBtn.onclick = () => {
            const name = input.value.trim() || finalName;
            cleanup();
            resolve(name);
        };

        cancelBtn.onclick = () => { cleanup(); resolve(null); };
    });
}


// Recording & upload
recordBtn.onclick = async ()=>{
    if(!isRecording){
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        audioChunks=[];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e=>audioChunks.push(e.data);
        mediaRecorder.start();
        isRecording=true;
        recordBtn.innerHTML='<i class="fa-solid fa-stop"></i> Stop Recording';
        downloadBtn.disabled=true;
    } else {
        mediaRecorder.stop();
        setTimeout(async ()=>{
            pendingFile = new Blob(audioChunks,{type:"audio/webm"});
            let filename = await askFilename("New Note");
            if(!filename) return;
            chosenFilename = filename;
            processAudio(pendingFile,chosenFilename);
            pendingFile=null;
        },100);
        isRecording=false;
        recordBtn.innerHTML='<i class="fa-solid fa-microphone"></i> Start Recording';
    }
};
uploadBtn.onclick = ()=>uploadInput.click();
uploadInput.onchange = async ()=>{ 
    const file = uploadInput.files[0]; 
    if(!file) return; 
    let filename = await askFilename(file.name.replace(/\.[^/.]+$/, ""));
    if(!filename) return;
    chosenFilename = filename;
    processAudio(file, filename); 
};

// Theme toggle
themeToggle.onclick = ()=>{
    document.body.classList.toggle("dark");
    themeToggle.innerHTML = document.body.classList.contains("dark")
        ? '<i class="fa-solid fa-sun"></i>'
        : '<i class="fa-solid fa-moon"></i>';
};

// Clear button
clearBtn.onclick = () => {
    audio.pause(); audio.src=""; seekBar.value=0; timeDisplay.textContent="00:00 / 00:00";
    transcriptDiv.textContent="None yet."; summaryDiv.textContent="None yet.";
    downloadBtn.disabled=true; chosenFilename="";
};

// Trash modal
trashBtn.onclick = () => { renderTrash(); trashModal.classList.remove("hidden"); };
closeTrashBtn.onclick = () => { trashModal.classList.add("hidden"); };

// Playback
downloadBtn.onclick = ()=>{
    const filename = chosenFilename+".txt";
    const content = `=== Transcript ===\n\n${latestTranscript}\n\n=== Summary ===\n\n${latestSummary}`;
    const blob = new Blob([content],{type:"text/plain"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
};

function formatTime(seconds){ const mins=Math.floor(seconds/60).toString().padStart(2,'0'); const secs=Math.floor(seconds%60).toString().padStart(2,'0'); return `${mins}:${secs}`; }
function loadAudio(file){ audio.src=URL.createObjectURL(file); audio.load(); audio.onloadedmetadata=()=>{ seekBar.max=Math.floor(audio.duration); timeDisplay.textContent=`00:00 / ${formatTime(audio.duration)}`; }; }
playBtn.onclick=()=>{ if(audio.paused){ audio.play(); playBtn.innerHTML='<i class="fa-solid fa-pause"></i>'; } else { audio.pause(); playBtn.innerHTML='<i class="fa-solid fa-play"></i>'; } };
audio.ontimeupdate=()=>{ seekBar.value=Math.floor(audio.currentTime); timeDisplay.textContent=`${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`; };
seekBar.oninput=()=>{ audio.currentTime=seekBar.value; };

async function processAudio(file, filename){
    loadAudio(file);
    transcriptDiv.textContent = "Processing...";
    summaryDiv.textContent = "";
    downloadBtn.disabled = true;

    const formData = new FormData();
    formData.append("audio_data", file, filename + ".webm");
    formData.append("filename", filename);

    try {
        const response = await fetch("/process_audio", { method: "POST", body: formData });
        const data = await response.json();

        if (data.error) {
            transcriptDiv.textContent = "‚ùå Error: " + data.error;
            summaryDiv.textContent = "";
        } else {
            latestTranscript = data.transcript;

            if (Array.isArray(data.summary)) {
                latestSummary = data.summary.map(item => `‚Ä¢ [${item.time}] ${item.text}`).join("\n");
                summaryDiv.innerHTML = "";
                const ul = document.createElement("ul");
                data.summary.forEach(item => {
                    const li = document.createElement("li");
                    li.style.cursor = "pointer"; li.style.marginBottom="0.4em";
                    li.innerHTML = `<strong>[${item.time}]</strong> ${item.text}`;
                    li.onclick = () => {
                        if(audio.duration){
                            const [min, sec] = item.time.split(":").map(Number);
                            audio.currentTime = min*60 + sec;
                            audio.play(); playBtn.innerHTML='<i class="fa-solid fa-pause"></i>';
                        }
                    };
                    ul.appendChild(li);
                });
                summaryDiv.appendChild(ul);
            } else { latestSummary = data.summary; summaryDiv.textContent = latestSummary; }
            transcriptDiv.textContent = latestTranscript;
            downloadBtn.disabled = false;
        }
    } catch(err) { transcriptDiv.textContent = "‚ùå Network error: "+err; }
    await addRecent(file, filename);
}

// Recent files management
async function addRecent(file, name){
    const now = new Date();
    const dateStr = now.toISOString().split("T")[0]; // YYYY-MM-DD
    const filePath = `${dateStr}/${name}`;

    // Already guaranteed unique via askFilename
    if(recentFiles.length >= 3) recentFiles.shift();
    const base64 = await blobToBase64(file);

    recentFiles.push({name: name, path: filePath, file: base64});
    localStorage.setItem("recentFiles", JSON.stringify(recentFiles));
    renderRecent();
}

async function renderRecent(){
    recentFilesDiv.innerHTML="";
    if(recentFiles.length===0){ recentFilesDiv.innerHTML='<span style="opacity:0.4;">No recent files</span>'; return; }
    recentFiles.forEach((item,index)=>{
        const div=document.createElement("div");
        div.className="recent-file-item";
        div.innerHTML=`<div class="waveform-icon">${'<div class="wave-bar"></div>'.repeat(5)}</div>${item.name}`;
        div.onclick=async ()=>{
            const blob=await base64ToBlob(item.file);
            loadAudio(blob);
            transcriptDiv.textContent="(Reload transcript manually)";
            summaryDiv.textContent="";
            chosenFilename=item.name;
        };
        recentFilesDiv.appendChild(div);
    });
}

// Trash rendering
function renderTrash(){
    trashList.innerHTML="";
    if(recentFiles.length===0){ trashList.innerHTML="<p>No files.</p>"; return; }
    recentFiles.forEach((item,index)=>{
        const div=document.createElement("div");
        div.style.display="flex"; div.style.justifyContent="space-between"; div.style.marginBottom="0.5em";
        const deleteBtn = document.createElement("button");
        deleteBtn.style.background="#ff4d4d";
        deleteBtn.style.color="#fff";
        deleteBtn.style.border="none";
        deleteBtn.style.padding="2px 6px";
        deleteBtn.style.borderRadius="5px";
        deleteBtn.textContent = "Delete";
        deleteBtn.onclick = async ()=>{
            try {
                const response = await fetch("/delete_recording", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({filename: item.path})
                });
                const data = await response.json();
                if(data.status==="deleted"){
                    recentFiles.splice(index,1);
                    localStorage.setItem("recentFiles", JSON.stringify(recentFiles));
                    renderRecent(); renderTrash();
                } else {
                    alert("Error deleting file: " + data.error);
                }
            } catch(err){
                alert("Network error: " + err);
            }
        };
        div.innerHTML = `<span>${item.name}</span>`;
        div.appendChild(deleteBtn);
        trashList.appendChild(div);
    });
}

window.addEventListener("load",()=>{
    const stored = localStorage.getItem("recentFiles");
    if(stored) recentFiles = JSON.parse(stored);
    renderRecent();
});
</script>

</body>
</html>
